{% extends "charts/charts.html" %} {% block chartField %}

<form id="form-ipt" class="form-inline">
	{{ form.userID(class="form-control", maxlength='8', placeholder='工号', value='PPPWQHXW')}}
	{{ form.dateRange(class="form-control",size='23',placeholder='日期范围') }}
	{% for subfield in form.modeDate %}
		{{ subfield }}{{ subfield.label }}
		&nbsp;&nbsp;
	{% endfor %}
	<input class="btn btn-primary" type="button" value="确认" onclick="refresh_chart()" />
</form>

<div id="chartConDateTrend" class="chartField"></div>

<script>
	var dateRangePicker = $("input[name='dateRange']");
	dateRangePicker.daterangepicker({
		autoUpdateInput: false,
		locale: {
			format: 'YYYY-MM-DD',
			cancelLabel: 'Clear'
		}
	});
	dateRangePicker.on('apply.daterangepicker', function(ev, picker) {
		$(this).val(picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD'));
	});
	dateRangePicker.on('cancel.daterangepicker', function(ev, picker) {
		$(this).val('');
	});

	// 图表初始化
	var chartConDateTrend = echarts.init(document.getElementById('chartConDateTrend'));

	// 自动缩放注册
	window.addEventListener('resize',
		function() {
			chartConDateTrend.resize();
		});

	// 默认Echarts配置
	var optchartConDateTrend = {
		title: {
			text: '消费日期变化'
		},
		legend:{},
		tooltip: {
			trigger: 'axis',
			formatter: function(params) {
				var str_return = params[0].name + '<br/>';
				for(var i = 0; i < params.length; i++) {
					if(params[i].value != 0) {
						str_return += params[i].seriesName + ' : ' + params[i].value + ' 元<br/>'
					}
				}
				return str_return;
			}
		},
		toolbox: {
			show: true,
			feature: {
				dataView: {
					show: true,
					readOnly: false
				},
				magicType: {
					show: true,
					type: ['line', 'bar']
				},
				restore: {
					show: true
				},
			}
		},
		xAxis: {
			type: 'category',
			boundaryGap: true,
			data: []
		},
		yAxis: {
			type: 'value',
			name: '金额',
			axisLabel: {
				formatter: '{value} 元'
			}
		},
		dataZoom: [
			{
				type: 'inside',
				xAxisIndex: [0],
				start: 0,
				end: 100
			}, 
			{
				type: 'slider',
				xAxisIndex: [0],
				start: 0,
				end: 100
			}
		],
		series:[]
	};
	
	// 设置默认配置
	chartConDateTrend.setOption(optchartConDateTrend);

	refresh_chart = function() {
		if($("#userID").val() == '') {
			showDialog("ID不可为空", json_response.errMsg);
			return;
		};

		chartConDateTrend.showLoading();

		$.ajax('/charts/condatetrend/getData?' + $("#form-ipt").serialize(), {
			type: 'GET',
			success: function(json_response) {
				chartConDateTrend.hideLoading();

				// 还原图表选项
				chartConDateTrend.setOption(optchartConDateTrend);

				if(!json_response.errMsg) {
					var legendLabels = json_response.legendLabels;
					var axisLabels = json_response.axisLabels;
					var seriesData=json_response.seriesData

					// 选项设定
					chartConDateTrend.setOption({
						legend: {
							data: legendLabels
						},
						xAxis: [{
							data: axisLabels
						}]
					});

					// 以下遇到更新部分数据时新数据合并旧数据而不是覆盖的问题
					var i = 0; // 定义重复要使用到的变量
					var tmp_option;

					// 清空series 并以notMerge 方式更新option.
					tmp_option = chartConDateTrend.getOption();
					tmp_option.series = [];
					chartConDateTrend.setOption(tmp_option, true);

					for(i = 0; i < seriesData.length; i++) {
						tmp_option = chartConDateTrend.getOption();
						tmp_option.series.push({
							name: seriesData[i].name,
							stack: 'con',
							type: 'bar',
							data: seriesData[i].data
						});
						chartConDateTrend.setOption(tmp_option, true);
					}
				} else {
					showDialog("出错了", json_response.errMsg);
				}
			},
			error: function() {
				showDialog("出错了", "出现意外情况");
			},
			dataType: 'json'
		});
	};
	
	$(document).ready(function() {
		refresh_chart();
	});
</script>

{% endblock %}