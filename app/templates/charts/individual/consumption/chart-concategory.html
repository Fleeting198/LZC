{% extends "charts/charts.html" %} {% block chartField %}

<form id="form-ipt" class="form-inline">
	{{ form.userID(class="form-control", maxlength='8', placeholder='工号', value='PPPWQHXW') }} 
	{{ form.dateRange(class="form-control",size='23',placeholder='日期范围') }}
	<input class="btn btn-primary" type="button" value="确认" onclick="refresh_chart()" />
</form>

<!--Echarts图表-->
<div id="chartConCategory" class="chartField_half"></div>

<!--DataTables表格-->
<div id="dataTableContainer" class="formField">
	<table id="tableConCategory">
		<thead>
			<tr>
				<th>类型</th>
				<th>金额（元）</th>
				<th>比例</th>
			</tr>
		</thead>
	</table>
</div>
<script>
	// Init dateRange.
	var dateRangePicker = $("input[name='dateRange']");
	dateRangePicker.daterangepicker({
		autoUpdateInput: false,
		locale: {
			format: 'YYYY-MM-DD',
			cancelLabel: 'Clear'
		}
	});
	dateRangePicker.on('apply.daterangepicker', function(ev, picker) {
		$(this).val(picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD'));
	});
	dateRangePicker.on('cancel.daterangepicker', function(ev, picker) {
		$(this).val('');
	});

	var optionChartConCategory = {
		title: {
			text: '消费类型比例'
		},
		tooltip: {
			trigger: 'item',
			formatter: "{a} <br/>{b} : {c} 元 ({d}%)"
		},
		toolbox: {
			show: true,
			feature: {
				mark: {
					show: true
				},
				dataView: {
					show: true,
					readOnly: false
				},
				restore: {
					show: true
				},
			}
		},
		legend: {
			show: true,
			orient: 'vertical',
			left: 'left',
			top: '30%',
		},
		series: [{
			name: '消费类型比例',
			type: 'pie',
		}]
	};

	refresh_chart = function() {
		if($("#userID").val() == '') {
			showDialog("ID不可为空", json_response.errMsg);
			return;
		};

		chartConCategory.showLoading();
		$.ajax('/charts/concategory/getData?' + $("#form-ipt").serialize(), {
			type: 'GET',
			success: function(json_response) {
				chartConCategory.hideLoading();
				chartConCategory.setOption(optionChartConCategory);

				if(!json_response.errMsg) {
					var titles = json_response.titles;
					var seriesData = json_response.seriesData;

					chartConCategory.setOption({
						legend: {
							data: titles
						},
						series: [{
							data: seriesData
						}]
					});

					// 刷新表格
					var form_columns= [{data:"类型"},{data:"金额（元）"},{data:"比例"}];
					var form_data=[];
					
					var i,sum=0;
					for (i=0;i<seriesData.length;i++){
						sum+=seriesData[i]["value"];
						form_data=form_data.concat({"类型":seriesData[i]["name"],"金额（元）":seriesData[i]["value"]});
					}
					for (i=0;i<seriesData.length;i++){
						form_data[i]["比例"]= (Math.round(form_data[i]["金额（元）"] / sum * 10000) / 100.00 + "%");
					}
					
					$("#tableConCategory").dataTable({
						destroy: true,
						columns: form_columns,
						data: form_data,
						ordering: true,
					});

				} else {
					showDialog("出错了", json_response.errMsg);
				}
			},
			error: function() {
				showDialog("出错了", "出现意外情况");
			},
			dataType: 'json',
		});
	};

	// Init charts.
	var chartConCategory = echarts.init(document.getElementById('chartConCategory'));
	chartConCategory.setOption(optionChartConCategory);
	
	window.addEventListener('resize', function() {
		chartConCategory.resize();
	});


	$(document).ready(function() {
		$("#tableConCategory").dataTable();
		refresh_chart();
	});
</script>

{% endblock %}