{% extends "charts.html" %}
{% block chartField %}

    <form id="form-ipt" class="form-inline" method="get">
        {{ form.userID(class="form-control", maxlength='8', placeholder='工号')}}
        {{ form.dateRange.label }} {{ form.dateRange(class="form-control",size='23') }}
        <input class="btn btn-primary" type="button" value="确认" onclick="refresh_chart()"/>
    </form>


    <div id="chart" style="width: 800px; height: 500px;"></div>

    <script>
        $("input[name='dateRange']").daterangepicker({
            autoUpdateInput: false,
            locale: {
                format: 'YYYY-MM-DD',
                cancelLabel: 'Clear'
            }
        });
        $('input[name="dateRange"]').on('apply.daterangepicker', function (ev, picker) {
            $(this).val(picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD'));
        });

        $('input[name="dateRange"]').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });

        // 图表初始化。
        var chart = echarts.init(document.getElementById('chart'));
        var option = {
            title: {text: '活动时间段分布'},
            tooltip: {trigger: 'axis'},
            toolbox: {
                show: true,
                feature: {
                    mark: {show: true},
                    dataView: {show: true, readOnly: false},
                    magicType: {show: true, type: ['line', 'bar']},
                    restore: {show: true},
                    saveAsImage: {show: true}
                }
            },
            legend: {data: ['门禁平均计数']},
            xAxis: {
                type: 'category',
                boundaryGap: true,
                data: []
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                name: '门禁平均计数',
                type: 'bar',
                data: []
            }]
        };
        chart.setOption(option);

        // get向后端请求json刷新图表。
        refresh_chart = function () {
            chart.showLoading();
            $.get('/charts/acperiod/getData?' + $("#form-ipt").serialize(), function (json_response) {
                chart.hideLoading();

                if (!json_response.errMsg) {
                    var mcounts = json_response.mcounts;
                    var mperiods = json_response.mperiods;
                    chart.setOption({
                        xAxis: [{
                            data: mperiods
                        }],
                        series: [{
                            data: mcounts
                        }]
                    })
                } else {
                    for (err in json_response.errMsg) {
                        alert(json_response.errMsg[err]);
                    }
                }
            }, 'json')
        };

        // 清空datetimepicker
        clear_picker = function (pid) {
            switch (pid) {
                case 1:
                    $("#ipt-startDate").val('');
                    break;
                case 2:
                    $("#ipt-endDate").val('');
                    break;
            }
        }
    </script>

{% endblock %}